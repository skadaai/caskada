# Documentation:
# https://direnv.net/man/direnv-stdlib.1.html

# Step 1: Load system dependencies (python, uv) from Nix.
strict_env
layout node
dotenv_if_exists

use nix

# Step 2: Define the path for our virtual environment.
VENV_DIR=".venv"

# Step 3: Create the virtual environment using uv if it doesn't exist.
# This replaces the creation part of `layout python`.
if [ ! -d "$VENV_DIR" ]; then
  echo "direnv: Creating virtual environment in '$VENV_DIR' with uv."
  # Use the 'python3' made available by Nix
  uv venv -p python3 "$VENV_DIR"
fi

# Step 4: Manually "activate" the environment in a direnv-friendly way.
# This replaces the activation part of `layout python`.
export VIRTUAL_ENV="$PWD/$VENV_DIR"
path_add PATH "$VIRTUAL_ENV/bin"

# Step 5: Add your project's code to the PYTHONPATH.
# 'path_add' safely creates the variable or prepends to it.
path_add PYTHONPATH python

# Step 6: Install dependencies with `uv pip`.
# 'watch_file' tells direnv to re-run this block if requirements.txt changes.
watch_file requirements.txt
if [ -f "requirements.txt" ]; then
  echo "direnv: Syncing dependencies with uv."
  uv pip install -r requirements.txt
fi
